package com.example.crm.security;

import com.example.crm.service.UserService; import io.jsonwebtoken.Claims; import io.jsonwebtoken.Jws; import jakarta.servlet.FilterChain; import jakarta.servlet.ServletException; import jakarta.servlet.http.HttpServletRequest; import jakarta.servlet.http.HttpServletResponse; import org.springframework.security.authentication.UsernamePasswordAuthenticationToken; import org.springframework.security.core.context.SecurityContextHolder; import org.springframework.security.core.userdetails.UserDetails; import org.springframework.security.web.authentication.WebAuthenticationDetailsSource; import org.springframework.stereotype.Component; import org.springframework.web.filter.OncePerRequestFilter; import java.io.IOException;

@Component public class JwtAuthFilter extends OncePerRequestFilter { private final JwtUtil jwt; private final UserService users; public JwtAuthFilter(JwtUtil j, UserService u){this.jwt=j; this.users=u;} @Override protected void doFilterInternal(HttpServletRequest req, HttpServletResponse res, FilterChain chain) throws ServletException, IOException { String auth = req.getHeader("Authorization"); if(auth!=null && auth.startsWith("Bearer ")){ String token = auth.substring(7); try{ Jws<Claims> jws = jwt.parse(token); String username = jws.getBody().getSubject(); if(username!=null && SecurityContextHolder.getContext().getAuthentication()==null){ UserDetails ud = users.loadUserByUsername(username); var at = new UsernamePasswordAuthenticationToken(ud, null, ud.getAuthorities()); at.setDetails(new WebAuthenticationDetailsSource().buildDetails(req)); SecurityContextHolder.getContext().setAuthentication(at);} } catch(Exception ignored){} } chain.doFilter(req,res);} }
